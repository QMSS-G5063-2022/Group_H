---
title: "Keywords by Genres and by Revenue"
author: "Maxxie Tang"
date: "4/19/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r dataset}
df <- read.csv("/Users/xintongtang/Desktop/Spring 2022/DataViz/Group/cleaned4.csv")

subset <- df[c("id","genres", "overview", "keywords", "revenue", "crew", "release_year")] #subset to columns needed 
```


```{r}
library(dplyr)
library(ggplot2)
library(ggthemes)
library(tidyverse)
library(tm)
library(SnowballC)
library(textstem)
library(stringr)
library(csv)
```

```{r, include=FALSE}
#DISREGARD, old code for seperating the genres

#genres_df <- as.data.frame(subset$genres)
#colnames(genres_df) <- c("genres")

#genres_sep <- genres_df %>% separate(genres, into =c('empty', 'id1','idnumber1', 'name1', 'genres1','id2','idnumber2', 'name2', 'genres2'))

#keep only two genres per movie 
#subset <- cbind(subset, genres1 = genres_sep$genres1)
#subset <- cbind(subset, genres2 = genres_sep$genres2)
```


```{r}
keywords_df <- as.data.frame(subset$keywords)
colnames(keywords_df) <- c("keywords")

keywords_df <- separate(keywords_df, 'keywords', paste("keywords", 1:20, sep="_"), sep=",", extra="drop")

keywords_df <- keywords_df[,c(2,4,6,8,10,12,14,16,18,20)]
```

```{r}
#clean the string
keywords_df <- mutate_all(keywords_df,
                   funs(str_replace_all(., "'name': ", "")))
keywords_df <- mutate_all(keywords_df,
                   funs(str_replace_all(., "\\}", "")))
keywords_df <- mutate_all(keywords_df,
                   funs(str_replace_all(., "\\]", "")))
keywords_df <- mutate_all(keywords_df,
                   funs(str_replace_all(., "\'", "")))
keywords_df <- mutate_all(keywords_df,
                   funs(str_replace_all(., "\"", "")))

keywords_df <- data.frame(lapply(keywords_df,trimws))
```

```{r}
#connect the words with space to make them one string
keywords_df <- mutate_all(keywords_df,
                   funs(str_replace_all(., "\\s", "-"))) 

keywords_df <- keywords_df %>%
  unite("keywords", keywords_2:keywords_20,sep = " ", remove = TRUE, na.rm = TRUE)

```

```{r}
subset <- cbind(subset, keywords_list = keywords_df$keywords)
#subset <- subset[!is.na(subset$keywords_list),]
```


###Comparing the wordcloud between genres. Comedy vs. Thriller&Horror. 

```{r}
#creating frequency table for two genres, Comedy and Thriller+Horror 
comedy <- subset(subset, genres == "Comedy")
comedy_corpus <- Corpus(VectorSource(comedy$keywords_list))

comedy_dtm <- TermDocumentMatrix(comedy_corpus) 
comedy_matrix <- as.matrix(comedy_dtm) 
words <- sort(rowSums(comedy_matrix),decreasing=TRUE) 
dd <- data.frame(word = names(words),freq=words)

#---------------------------------------

thril_horror <- subset(subset, genres == "Thriller"|genres == "Horror")
thril_horror_corpus <- Corpus(VectorSource(thril_horror$keywords_list))

thril_horror_dtm <- TermDocumentMatrix(thril_horror_corpus) 
thril_horror_matrix <- as.matrix(thril_horror_dtm) 
words <- sort(rowSums(thril_horror_matrix),decreasing=TRUE) 
ff <- data.frame(word = names(words),freq=words)

```

```{r}
library(wordcloud)
library(RColorBrewer)

set.seed(1234)
wordcloud(words = dd$word, freq = dd$freq, min.freq = 1,
          max.words=100, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```

```{r}
set.seed(1234)
wordcloud(words = ff$word, freq = ff$freq, min.freq = 1,
          max.words=100, random.order=FALSE, rot.per=0.35, 
          colors=brewer.pal(8, "Dark2"))
```

## Looking at keywords by high revenue vs low revenue movies 
Use the average as a reference point for high and low revenue. The average is around $10 million, so for the easy of use, defining revenue above 10,000,000 as High revenue movie and below as Low revenue movies.

```{r}
mean(subset$revenue,na.rm=TRUE) 
# for the easy of use, defining revenue above 10,000,000 as High revenue and below as Low  
```

```{r}
high <- subset(subset, revenue > 10000000)
high_corpus <- Corpus(VectorSource(high$keywords_list))
high_dtm <- TermDocumentMatrix(high_corpus) 
high_matrix <- as.matrix(high_dtm) 
v1 <- sort(rowSums(high_matrix),decreasing=TRUE)
high_freq <- data.frame(word = names(v1),freq=v1)

low <- subset(subset, revenue <= 10000000)
low_corpus <- Corpus(VectorSource(low$keywords_list))
low_dtm <- TermDocumentMatrix(low_corpus) 
low_matrix <- as.matrix(low_dtm) 
v2 <- sort(rowSums(low_matrix),decreasing=TRUE)
low_freq <- data.frame(word = names(v2),freq=v2)
```


```{r}
library(plotrix)
commonword <- merge(as.data.frame(high_freq), as.data.frame(low_freq), by.x = "word", by.y = "word", sort = TRUE)

#order by the frequency of low revenue movies
commonword <- commonword[order(commonword$freq.y, decreasing = TRUE),]

top20 <- commonword[(1:20),]

p <- pyramid.plot(top20$freq.x, top20$freq.y,
                  labels = top20$word,
             #gap = 250,
             top.labels = c("High Revenue", " ", "Low Revenue"),
             main = "Words in Common",
             gap = 28,
             laxlab = NULL,
             raxlab = NULL,
             unit = NULL,
             labelcex=0.5)
```

The common words show some insight to the movie industries. Independent film are high risk and usually have a niche market. The common words duringcreditstinger is a very common "technique" in blockbuster movies such as Marvel's superheros series. 

###keywords change over time 

There some keywords that show the trend in the movie industry. We want to see if there are more movie directed by woman, if there are more independent movies released over the year. And just to understand if there are more creditstinger since Marvel studio start setting the trend

```{r}
all_corpus <- Corpus(VectorSource(subset$keywords_list))

dtm <- TermDocumentMatrix(all_corpus) 
matrix <- as.matrix(dtm) 
words <- sort(rowSums(matrix),decreasing=TRUE) 
all_words <- data.frame(word = names(words),freq=words)

```


```{r}

words_of_interest <- 
  subset %>%
  group_by(release_year)%>%
  summarise(women_director = sum(str_count(keywords_list, all_words$word[4])),
            creditstinger = sum(str_count(keywords_list, all_words$word[2])
                                +str_count(keywords_list, all_words$word[7])),
            independent_film = sum(str_count(keywords_list, all_words$word[3])))


```

```{r}
words_of_interest <- as.data.frame(words_of_interest)
#words_of_interest
```

```{r}
library(reshape2)
long <- melt(words_of_interest, id.var = c("release_year"), variable.name = c("keywords"))

long$release_year <- as.integer(long$release_year)

#long
```



```{r}
library(ggplot2)
library(gganimate)
library(gifski)

#basic bar chart 
animation <- 
  ggplot(long, aes(x = release_year, y = value, group = keywords, color = keywords))+ 
  geom_line()+
  geom_point() +
  xlab("Year") + ylab("Number of Movies") +
## make it move
  transition_reveal(release_year)+ shadow_mark() +
  enter_grow() +
  exit_fade() +
  labs(title = 'Movie Trend Overtime',  
       caption  = "data as of April 2022")

animate(animation,width = 600, height = 600, renderer = gifski_renderer())
  
anim_save("keywords-animated-barplot.gif") 
```


###Directors 

Made two chart visualizations

```{r}
library(stringr)

subset$director <- str_match(subset$crew, "Director', 'name':\\s*(.*?), 'profile_path")[,2]

subset$director <-str_replace_all(subset$director, "\'", "")

subset$director <-str_replace_all(subset$director, "\"", "")

```

```{r}
# finding the top 10 directors by revenue 

top10 <- 
  subset %>%
  group_by(director) %>%
  summarise(revenue = sum(revenue))

```

```{r}
top10 <-top10[order(-top10$revenue),][1:10,]

top10$revenue <- round((top10$revenue/100000), digits = 0)

```

```{r}
ggplot(top10, aes(director, revenue)) + geom_bar(fill="white", colour="darkgreen", 
           alpha=0.5, stat="identity") + coord_flip() + scale_x_discrete() + 
           scale_y_continuous(breaks=seq(0,90000 , 10000)) + theme_bw() + 
           xlab("Movie Director") + ylab("Total Revenue in $Million")
           theme(axis.title.x  = element_blank(), axis.title.y  = element_blank())
```

```{r}
library(echarts4r)
library(png)
#library(echarts4r.assets)


top10 %>% 
  e_charts(director) %>% 
  e_dims(height = "auto", width = "auto") %>%
  e_pictorial(revenue, symbol = "circle" , 
              symbolRepeat = TRUE, z = -1,
              symbolSize = c(15, 15)) %>% 
  e_theme("westeros") %>%
  e_title("Total Revenue in Million for Top10 Directors", left = "center", top = 5, 
          textStyle = list(fontSize = 15)) %>% 
  e_flip_coords() %>%
  # Hide Legend
  e_legend(show = FALSE) %>%
  # Remove Gridlines
  e_x_axis(splitLine=list(show = FALSE)) %>%
  e_y_axis(splitLine=list(show = FALSE), axisLabel = list(interval = 0, rotate = 30)) %>%
  # Format Label
  e_labels(fontSize = 10, fontWeight ='bold', position = "right", offset=c(10, 0),)

```

